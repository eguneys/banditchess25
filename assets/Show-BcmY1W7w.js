import{m as _t,s as Nn,b as C,f as Nt,C as Ln,o as On,e as ee,t as A,g as Lt,_ as Bn,h as xe,j as Ot,c as w,k as Hn,l as Rn,n as X,p as Wn,q as de,i as b,r as Le,v as Kn,a as bt,w as zn,u as jn,x as In,y as Fn,S as I,z as Ve,A as Gn,B as Vn,D as Un,E as Yn,F as Zn,G as Xn,H as Qn,I as wt,J as Jn,K as er,L as yt,M as kt,d as tr,N as nr}from"./index-BpXD8XUH.js";import{M as ue}from"./MeetButton-CnGYIA6x.js";import{L as Ct}from"./Leaderboard-Bt3gUzD9.js";const rr=(e,t)=>{const n=new Map,r=e.ctx();for(const[o,i]of e.allDests(r))if(i.nonEmpty()){const l=Array.from(i,_t);o===r.king&&Nn(o)===4&&(i.has(0)?l.push("c1"):i.has(56)&&l.push("c8"),i.has(7)?l.push("g1"):i.has(63)&&l.push("g8")),n.set(_t(o),l)}return n},or=["white","black"],qe=["a","b","c","d","e","f","g","h"],Ae=["1","2","3","4","5","6","7","8"],ir=[...Ae].reverse(),Je=Array.prototype.concat(...qe.map(e=>Ae.map(t=>e+t))),F=e=>Je[8*e[0]+e[1]],M=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],Bt=Je.map(M);function sr(e){let t;const n=()=>(t===void 0&&(t=e()),t);return n.clear=()=>{t=void 0},n}const lr=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},et=e=>e==="white"?"black":"white",Ce=(e,t)=>{const n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r},Ue=(e,t)=>e.role===t.role&&e.color===t.color,Se=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],Q=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},Ht=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},tt=(e,t)=>{e.style.visibility=t?"visible":"hidden"},pe=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},Rt=e=>e.button===2,te=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function Wt(e,t,n){const r=M(e);return t||(r[0]=7-r[0],r[1]=7-r[1]),[n.left+n.width*r[0]/8+n.width/16,n.top+n.height*(7-r[1])/8+n.height/16]}const fe=(e,t)=>Math.abs(e-t),cr=e=>(t,n,r,o)=>fe(t,r)<2&&(e==="white"?o===n+1||n<=1&&o===n+2&&t===r:o===n-1||n>=6&&o===n-2&&t===r),Kt=(e,t,n,r)=>{const o=fe(e,n),i=fe(t,r);return o===1&&i===2||o===2&&i===1},zt=(e,t,n,r)=>fe(e,n)===fe(t,r),jt=(e,t,n,r)=>e===n||t===r,It=(e,t,n,r)=>zt(e,t,n,r)||jt(e,t,n,r),ar=(e,t,n)=>(r,o,i,l)=>fe(r,i)<2&&fe(o,l)<2||n&&o===l&&o===(e==="white"?0:7)&&(r===4&&(i===2&&t.includes(0)||i===6&&t.includes(7))||t.includes(i));function dr(e,t){const n=t==="white"?"1":"8",r=[];for(const[o,i]of e)o[1]===n&&i.color===t&&i.role==="rook"&&r.push(M(o)[0]);return r}function Ft(e,t,n){const r=e.get(t);if(!r)return[];const o=M(t),i=r.role,l=i==="pawn"?cr(r.color):i==="knight"?Kt:i==="bishop"?zt:i==="rook"?jt:i==="queen"?It:ar(r.color,dr(e,r.color),n);return Bt.filter(s=>(o[0]!==s[0]||o[1]!==s[1])&&l(o[0],o[1],s[0],s[1])).map(F)}function K(e,...t){e&&setTimeout(()=>e(...t),1)}function ur(e){e.orientation=et(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function fr(e,t){for(const[n,r]of t)r?e.pieces.set(n,r):e.pieces.delete(n)}function pr(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[n,r]of e.pieces)r.role==="king"&&r.color===t&&(e.check=n)}function hr(e,t,n,r){oe(e),e.premovable.current=[t,n],K(e.premovable.events.set,t,n,r)}function re(e){e.premovable.current&&(e.premovable.current=void 0,K(e.premovable.events.unset))}function gr(e,t,n){re(e),e.predroppable.current={role:t,key:n},K(e.predroppable.events.set,t,n)}function oe(e){const t=e.predroppable;t.current&&(t.current=void 0,K(t.events.unset))}function mr(e,t,n){if(!e.autoCastle)return!1;const r=e.pieces.get(t);if(!r||r.role!=="king")return!1;const o=M(t),i=M(n);if(o[1]!==0&&o[1]!==7||o[1]!==i[1])return!1;o[0]===4&&!e.pieces.has(n)&&(i[0]===6?n=F([7,i[1]]):i[0]===2&&(n=F([0,i[1]])));const l=e.pieces.get(n);return!l||l.color!==r.color||l.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(n),o[0]<i[0]?(e.pieces.set(F([6,i[1]]),r),e.pieces.set(F([5,i[1]]),l)):(e.pieces.set(F([2,i[1]]),r),e.pieces.set(F([3,i[1]]),l)),!0)}function Gt(e,t,n){const r=e.pieces.get(t),o=e.pieces.get(n);if(t===n||!r)return!1;const i=o&&o.color!==r.color?o:void 0;return n===e.selected&&G(e),K(e.events.move,t,n,i),mr(e,t,n)||(e.pieces.set(n,r),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,K(e.events.change),i||!0}function nt(e,t,n,r){if(e.pieces.has(n))if(r)e.pieces.delete(n);else return!1;return K(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,K(e.events.change),e.movable.dests=void 0,e.turnColor=et(e.turnColor),!0}function Vt(e,t,n){const r=Gt(e,t,n);return r&&(e.movable.dests=void 0,e.turnColor=et(e.turnColor),e.animation.current=void 0),r}function Ut(e,t,n){if(rt(e,t,n)){const r=Vt(e,t,n);if(r){const o=e.hold.stop();G(e);const i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:o};return r!==!0&&(i.captured=r),K(e.movable.events.after,t,n,i),!0}}else if(_r(e,t,n))return hr(e,t,n,{ctrlKey:e.stats.ctrlKey}),G(e),!0;return G(e),!1}function Yt(e,t,n,r){const o=e.pieces.get(t);o&&(vr(e,t,n)||r)?(e.pieces.delete(t),nt(e,o,n,r),K(e.movable.events.afterNewPiece,o.role,n,{premove:!1,predrop:!1})):o&&br(e,t,n)?gr(e,o.role,n):(re(e),oe(e)),e.pieces.delete(t),G(e)}function Ye(e,t,n){if(K(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){G(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==t&&Ut(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(Xt(e,t)||ot(e,t))&&(Zt(e,t),e.hold.start())}function Zt(e,t){e.selected=t,ot(e,t)?e.premovable.customDests||(e.premovable.dests=Ft(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function G(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Xt(e,t){const n=e.pieces.get(t);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}const rt=(e,t,n)=>{var r,o;return t!==n&&Xt(e,t)&&(e.movable.free||!!(!((o=(r=e.movable.dests)===null||r===void 0?void 0:r.get(t))===null||o===void 0)&&o.includes(n)))};function vr(e,t,n){const r=e.pieces.get(t);return!!r&&(t===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}function ot(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function _r(e,t,n){var r,o;const i=(o=(r=e.premovable.customDests)===null||r===void 0?void 0:r.get(t))!==null&&o!==void 0?o:Ft(e.pieces,t,e.premovable.castle);return t!==n&&ot(e,t)&&i.includes(n)}function br(e,t,n){const r=e.pieces.get(t),o=e.pieces.get(n);return!!r&&(!o||o.color!==e.movable.color)&&e.predroppable.enabled&&(r.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===r.color&&e.turnColor!==r.color}function wr(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function yr(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],r=t[1];let o=!1;if(rt(e,n,r)){const i=Vt(e,n,r);if(i){const l={premove:!0};i!==!0&&(l.captured=i),K(e.movable.events.after,n,r,l),o=!0}}return re(e),o}function kr(e,t){const n=e.predroppable.current;let r=!1;if(!n)return!1;if(t(n)){const o={role:n.role,color:e.movable.color};nt(e,o,n.key)&&(K(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),r=!0)}return oe(e),r}function it(e){re(e),oe(e),G(e)}function St(e){e.movable.color=e.movable.dests=e.animation.current=void 0,it(e)}function he(e,t,n){let r=Math.floor(8*(e[0]-n.left)/n.width);t||(r=7-r);let o=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(o=7-o),r>=0&&r<8&&o>=0&&o<8?F([r,o]):void 0}function Cr(e,t,n,r){const o=M(e),i=Bt.filter(c=>It(o[0],o[1],c[0],c[1])||Kt(o[0],o[1],c[0],c[1])),s=i.map(c=>Wt(F(c),n,r)).map(c=>Ce(t,c)),[,d]=s.reduce((c,u,a)=>c[0]<u?c:[u,a],[s[0],0]);return F(i[d])}const z=e=>e.orientation==="white",Qt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Sr={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},$r={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Jt(e){e==="start"&&(e=Qt);const t=new Map;let n=7,r=0;for(const o of e)switch(o){case" ":case"[":return t;case"/":if(--n,n<0)return t;r=0;break;case"~":{const i=t.get(F([r-1,n]));i&&(i.promoted=!0);break}default:{const i=o.charCodeAt(0);if(i<57)r+=i-48;else{const l=o.toLowerCase();t.set(F([r,n]),{role:Sr[l],color:o===l?"black":"white"}),++r}}}return t}function Pr(e){return ir.map(t=>qe.map(n=>{const r=e.get(n+t);if(r){let o=$r[r.role];return r.color==="white"&&(o=o.toUpperCase()),r.promoted&&(o+="~"),o}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function en(e,t){t.animation&&(st(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function tn(e,t){var n,r,o;if(!((n=t.movable)===null||n===void 0)&&n.dests&&(e.movable.dests=void 0),!((r=t.drawable)===null||r===void 0)&&r.autoShapes&&(e.drawable.autoShapes=[]),st(e,t),t.fen&&(e.pieces=Jt(t.fen),e.drawable.shapes=((o=t.drawable)===null||o===void 0?void 0:o.shapes)||[]),"check"in t&&pr(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Zt(e,e.selected),en(e,t),!e.movable.rookCastle&&e.movable.dests){const i=e.movable.color==="white"?"1":"8",l="e"+i,s=e.movable.dests.get(l),d=e.pieces.get(l);if(!s||!d||d.role!=="king")return;e.movable.dests.set(l,s.filter(c=>!(c==="a"+i&&s.includes("c"+i))&&!(c==="h"+i&&s.includes("g"+i))))}}function st(e,t){for(const n in t)n==="__proto__"||n==="constructor"||!Object.prototype.hasOwnProperty.call(t,n)||(Object.prototype.hasOwnProperty.call(e,n)&&$t(e[n])&&$t(t[n])?st(e[n],t[n]):e[n]=t[n])}function $t(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const ae=(e,t)=>t.animation.enabled?qr(e,t):ne(e,t);function ne(e,t){const n=e(t);return t.dom.redraw(),n}const je=(e,t)=>({key:e,pos:M(e),piece:t}),Mr=(e,t)=>t.sort((n,r)=>Ce(e.pos,n.pos)-Ce(e.pos,r.pos))[0];function xr(e,t){const n=new Map,r=[],o=new Map,i=[],l=[],s=new Map;let d,c,u;for(const[a,f]of e)s.set(a,je(a,f));for(const a of Je)d=t.pieces.get(a),c=s.get(a),d?c?Ue(d,c.piece)||(i.push(c),l.push(je(a,d))):l.push(je(a,d)):c&&i.push(c);for(const a of l)c=Mr(a,i.filter(f=>Ue(a.piece,f.piece))),c&&(u=[c.pos[0]-a.pos[0],c.pos[1]-a.pos[1]],n.set(a.key,u.concat(u)),r.push(c.key));for(const a of i)r.includes(a.key)||o.set(a.key,a.piece);return{anims:n,fadings:o}}function nn(e,t){const n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}const r=1-(t-n.start)*n.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{const o=Ar(r);for(const i of n.plan.anims.values())i[2]=i[0]*o,i[3]=i[1]*o;e.dom.redrawNow(!0),requestAnimationFrame((i=performance.now())=>nn(e,i))}}function qr(e,t){const n=new Map(t.pieces),r=e(t),o=xr(n,t);if(o.anims.size||o.fadings.size){const i=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:o},i||nn(t,performance.now())}else t.dom.redraw();return r}const Ar=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,Dr=["green","red","blue","yellow"];function Tr(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?G(e):it(e);const n=pe(t),r=he(n,z(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:n,brush:Or(t),snapToValidMove:e.drawable.defaultSnapToValidMove},rn(e))}function rn(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const n=he(t.pos,z(e),e.dom.bounds());n||(t.snapToValidMove=!1);const r=t.snapToValidMove?Cr(t.orig,t.pos,z(e),e.dom.bounds()):n;r!==t.mouseSq&&(t.mouseSq=r,t.dest=r!==t.orig?r:void 0,e.dom.redrawNow()),rn(e)}})}function Er(e,t){e.drawable.current&&(e.drawable.current.pos=pe(t))}function Nr(e){const t=e.drawable.current;t&&(t.mouseSq&&Br(e.drawable,t),on(e))}function on(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Lr(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),sn(e.drawable))}function Or(e){var t;const n=(e.shiftKey||e.ctrlKey)&&Rt(e),r=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return Dr[(n?1:0)+(r?2:0)]}function Br(e,t){const n=o=>o.orig===t.orig&&o.dest===t.dest,r=e.shapes.find(n);r&&(e.shapes=e.shapes.filter(o=>!n(o))),(!r||r.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),sn(e)}function sn(e){e.onChange&&e.onChange(e.shapes)}function Hr(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),r=pe(t),o=he(r,z(e),n);if(!o)return;const i=e.pieces.get(o),l=e.selected;if(!l&&e.drawable.enabled&&(e.drawable.eraseOnClick||!i||i.color!==e.turnColor)&&Lr(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||i||l||Rr(e,r)))t.preventDefault();else if(t.touches)return;const s=!!e.premovable.current,d=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&rt(e,e.selected,o)?ae(a=>Ye(a,o),e):Ye(e,o);const c=e.selected===o,u=cn(e,o);if(i&&u&&c&&wr(e,o)){e.draggable.current={orig:o,piece:i,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:u,previouslySelected:l,originTarget:t.target,keyHasChanged:!1},u.cgDragging=!0,u.classList.add("dragging");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${i.color} ${i.role}`,Q(a,Se(n)(M(o),z(e))),tt(a,!0)),lt(e)}else s&&re(e),d&&oe(e);e.dom.redraw()}function Rr(e,t){const n=z(e),r=e.dom.bounds(),o=Math.pow(r.width/8,2);for(const i of e.pieces.keys()){const l=Wt(i,n,r);if(Ce(l,t)<=o)return!0}return!1}function Wr(e,t,n,r){const o="a0";e.pieces.set(o,t),e.dom.redraw();const i=pe(n);e.draggable.current={orig:o,piece:t,origPos:i,pos:i,started:!0,element:()=>cn(e,o),originTarget:n.target,newPiece:!0,force:!!r,keyHasChanged:!1},lt(e)}function lt(e){requestAnimationFrame(()=>{var t;const n=e.draggable.current;if(!n)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(n.orig)&&(e.animation.current=void 0);const r=e.pieces.get(n.orig);if(!r||!Ue(r,n.piece))De(e);else if(!n.started&&Ce(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const i=n.element();if(!i)return;i.cgDragging=!0,i.classList.add("dragging"),n.element=i}const o=e.dom.bounds();Q(n.element,[n.pos[0]-o.left-o.width/16,n.pos[1]-o.top-o.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==he(n.pos,z(e),o))}lt(e)})}function Kr(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=pe(t))}function zr(e,t){const n=e.draggable.current;if(!n)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&n.originTarget!==t.target&&!n.newPiece){e.draggable.current=void 0;return}re(e),oe(e);const r=pe(t)||n.pos,o=he(r,z(e),e.dom.bounds());o&&n.started&&n.orig!==o?n.newPiece?Yt(e,n.orig,o,n.force):(e.stats.ctrlKey=t.ctrlKey,Ut(e,n.orig,o)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!o&&(e.pieces.delete(n.orig),K(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===o||!o)?G(e):e.selectable.enabled||G(e),ln(e),e.draggable.current=void 0,e.dom.redraw()}function De(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,G(e),ln(e),e.dom.redraw())}function ln(e){const t=e.dom.elements;t.ghost&&tt(t.ghost,!1)}function cn(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&n.tagName==="PIECE")return n;n=n.nextSibling}}function jr(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{Pt(e,2),setTimeout(()=>Pt(e,void 0),120)},120)}function Pt(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Ir(e,t){function n(){ur(e),t()}return{set(r){r.orientation&&r.orientation!==e.orientation&&n(),en(e,r),(r.fen?ae:ne)(o=>tn(o,r),e)},state:e,getFen:()=>Pr(e.pieces),toggleOrientation:n,setPieces(r){ae(o=>fr(o,r),e)},selectSquare(r,o){r?ae(i=>Ye(i,r,o),e):e.selected&&(G(e),e.dom.redraw())},move(r,o){ae(i=>Gt(i,r,o),e)},newPiece(r,o){ae(i=>nt(i,r,o),e)},playPremove(){if(e.premovable.current){if(ae(yr,e))return!0;e.dom.redraw()}return!1},playPredrop(r){if(e.predroppable.current){const o=kr(e,r);return e.dom.redraw(),o}return!1},cancelPremove(){ne(re,e)},cancelPredrop(){ne(oe,e)},cancelMove(){ne(r=>{it(r),De(r)},e)},stop(){ne(r=>{St(r),De(r)},e)},explode(r){jr(e,r)},setAutoShapes(r){ne(o=>o.drawable.autoShapes=r,e)},setShapes(r){ne(o=>o.drawable.shapes=r,e)},getKeyAtDomPos(r){return he(r,z(e),e.dom.bounds())},redrawAll:t,dragNewPiece(r,o,i){Wr(e,r,o,i)},destroy(){St(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Fr(){return{pieces:Jt(Qt),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:lr()}}const Mt={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function Gr(){const e=D("defs"),t=H(D("filter"),{id:"cg-filter-blur"});return t.appendChild(H(D("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function Vr(e,t,n){var r;const o=e.drawable,i=o.current,l=i&&i.mouseSq?i:void 0,s=new Map,d=e.dom.bounds(),c=o.autoShapes.filter(h=>!h.piece);for(const h of o.shapes.concat(c).concat(l?[l]:[])){if(!h.dest)continue;const _=(r=s.get(h.dest))!==null&&r!==void 0?r:new Set,v=Ne(Ee(M(h.orig),e.orientation),d),p=Ne(Ee(M(h.dest),e.orientation),d);_.add(Xe(v,p)),s.set(h.dest,_)}const u=o.shapes.concat(c).map(h=>({shape:h,current:!1,hash:xt(h,Ze(h.dest,s),!1,d)}));l&&u.push({shape:l,current:!0,hash:xt(l,Ze(l.dest,s),!0,d)});const a=u.map(h=>h.hash).join(";");if(a===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=a;const f=t.querySelector("defs");Ur(o,u,f),Yr(u,t.querySelector("g"),n.querySelector("g"),h=>Qr(e,h,o.brushes,s,d))}function Ur(e,t,n){var r;const o=new Map;let i;for(const d of t.filter(c=>c.shape.dest&&c.shape.brush))i=an(e.brushes[d.shape.brush],d.shape.modifiers),!((r=d.shape.modifiers)===null||r===void 0)&&r.hilite&&o.set(Te(i).key,Te(i)),o.set(i.key,i);const l=new Set;let s=n.firstElementChild;for(;s;)l.add(s.getAttribute("cgKey")),s=s.nextElementSibling;for(const[d,c]of o.entries())l.has(d)||n.appendChild(to(c))}function Yr(e,t,n,r){const o=new Map;for(const i of e)o.set(i.hash,!1);for(const i of[t,n]){const l=[];let s=i.firstElementChild,d;for(;s;)d=s.getAttribute("cgHash"),o.has(d)?o.set(d,!0):l.push(s),s=s.nextElementSibling;for(const c of l)i.removeChild(c)}for(const i of e.filter(l=>!o.get(l.hash)))for(const l of r(i))l.isCustom?n.appendChild(l.el):t.appendChild(l.el)}function xt({orig:e,dest:t,brush:n,piece:r,modifiers:o,customSvg:i,label:l},s,d,c){var u,a;return[c.width,c.height,d,e,t,n,s&&"-",r&&Zr(r),o&&Xr(o),i&&`custom-${qt(i.html)},${(a=(u=i.center)===null||u===void 0?void 0:u[0])!==null&&a!==void 0?a:"o"}`,l&&`label-${qt(l.text)}`].filter(f=>f).join(",")}function Zr(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function Xr(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function qt(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return t.toString()}function Qr(e,{shape:t,current:n,hash:r},o,i,l){var s,d;const c=Ne(Ee(M(t.orig),e.orientation),l),u=t.dest?Ne(Ee(M(t.dest),e.orientation),l):c,a=t.brush&&an(o[t.brush],t.modifiers),f=i.get(t.dest),h=[];if(a){const _=H(D("g"),{cgHash:r});h.push({el:_}),c[0]!==u[0]||c[1]!==u[1]?_.appendChild(eo(t,a,c,u,n,Ze(t.dest,i))):_.appendChild(Jr(o[t.brush],c,n,l))}if(t.label){const _=t.label;(s=_.fill)!==null&&s!==void 0||(_.fill=t.brush&&o[t.brush].color);const v=t.brush?void 0:"tr";h.push({el:no(_,r,c,u,f,v),isCustom:!0})}if(t.customSvg){const _=(d=t.customSvg.center)!==null&&d!==void 0?d:"orig",[v,p]=_==="label"?un(c,u,f).map($=>$-.5):_==="dest"?u:c,m=H(D("g"),{transform:`translate(${v},${p})`,cgHash:r});m.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,h.push({el:m,isCustom:!0})}return h}function Jr(e,t,n,r){const o=ro(),i=(r.width+r.height)/(4*Math.max(r.width,r.height));return H(D("circle"),{stroke:e.color,"stroke-width":o[n?0:1],fill:"none",opacity:dn(e,n),cx:t[0],cy:t[1],r:i-o[1]/2})}function Te(e){return["#ffffff","#fff","white"].includes(e.color)?Mt.hilitePrimary:Mt.hiliteWhite}function eo(e,t,n,r,o,i){var l;function s(u){var a;const f=io(i&&!o),h=r[0]-n[0],_=r[1]-n[1],v=Math.atan2(_,h),p=Math.cos(v)*f,m=Math.sin(v)*f;return H(D("line"),{stroke:u?Te(t).color:t.color,"stroke-width":oo(t,o)+(u?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${u?Te(t).key:t.key})`,opacity:!((a=e.modifiers)===null||a===void 0)&&a.hilite?1:dn(t,o),x1:n[0],y1:n[1],x2:r[0]-p,y2:r[1]-m})}if(!(!((l=e.modifiers)===null||l===void 0)&&l.hilite))return s(!1);const d=D("g"),c=H(D("g"),{filter:"url(#cg-filter-blur)"});return c.appendChild(so(n,r)),c.appendChild(s(!0)),d.appendChild(c),d.appendChild(s(!1)),d}function to(e){const t=H(D("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(H(D("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function no(e,t,n,r,o,i){var l;const d=.4*.75**e.text.length,c=un(n,r,o),u=i==="tr"?.4:0,a=H(D("g"),{transform:`translate(${c[0]+u},${c[1]-u})`,cgHash:t});a.appendChild(H(D("circle"),{r:.4/2,"fill-opacity":i?1:.8,"stroke-opacity":i?1:.7,"stroke-width":.03,fill:(l=e.fill)!==null&&l!==void 0?l:"#666",stroke:"white"}));const f=H(D("text"),{"font-size":d,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return f.innerHTML=e.text,a.appendChild(f),a}function Ee(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function Ze(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function D(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function H(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);return e}function an(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(n=>n).join("")}:e}function ro(){return[3/64,4/64]}function oo(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function dn(e,t){return(e.opacity||1)*(t?.9:1)}function io(e){return(e?20:10)/64}function Ne(e,t){const n=Math.min(1,t.width/t.height),r=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*r]}function so(e,t){const n={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return H(D("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function Xe(e,t,n=!0){const r=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return n?(Math.round(r*8/Math.PI)+16)%16:r}function lo(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((n,r)=>n+r*r,0))}function un(e,t,n){let r=lo(e,t);const o=Xe(e,t,!1);if(n&&(r-=33/64,n.size>1)){r-=10/64;const i=Xe(e,t);(n.has((i+1)%16)||n.has((i+15)%16))&&i&1&&(r-=.4)}return[e[0]-Math.cos(o)*r,e[1]-Math.sin(o)*r].map(i=>i+.5)}function co(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const d of or)e.classList.toggle("orientation-"+d,t.orientation===d);e.classList.toggle("manipulable",!t.viewOnly);const n=te("cg-container");e.appendChild(n);const r=te("cg-board");n.appendChild(r);let o,i,l;if(t.drawable.visible&&(o=H(D("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(Gr()),o.appendChild(D("g")),i=H(D("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(D("g")),l=te("cg-auto-pieces"),n.appendChild(o),n.appendChild(i),n.appendChild(l)),t.coordinates){const d=t.orientation==="black"?" black":"",c=t.ranksPosition==="left"?" left":"";if(t.coordinatesOnSquares){const u=t.orientation==="white"?a=>a+1:a=>8-a;qe.forEach((a,f)=>n.appendChild(Ie(Ae.map(h=>a+h),"squares rank"+u(f)+d+c)))}else n.appendChild(Ie(Ae,"ranks"+d+c)),n.appendChild(Ie(qe,"files"+d))}let s;return t.draggable.enabled&&t.draggable.showGhost&&(s=te("piece","ghost"),tt(s,!1),n.appendChild(s)),{board:r,container:n,wrap:e,ghost:s,svg:o,customSvg:i,autoPieces:l}}function Ie(e,t){const n=te("coords",t);let r;for(const o of e)r=te("coord"),r.textContent=o,n.appendChild(r);return n}function ao(e,t){if(!e.dropmode.active)return;re(e),oe(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const r=pe(t),o=r&&he(r,z(e),e.dom.bounds());o&&Yt(e,"a0",o)}e.dom.redraw()}function uo(e,t){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",o=>o.preventDefault()),e.viewOnly)return;const r=po(e);n.addEventListener("touchstart",r,{passive:!1}),n.addEventListener("mousedown",r,{passive:!1})}function fo(e,t){const n=[];if("ResizeObserver"in window||n.push(we(document.body,"chessground.resize",t)),!e.viewOnly){const r=At(e,Kr,Er),o=At(e,zr,Nr);for(const l of["touchmove","mousemove"])n.push(we(document,l,r));for(const l of["touchend","mouseup"])n.push(we(document,l,o));const i=()=>e.dom.bounds.clear();n.push(we(document,"scroll",i,{capture:!0,passive:!0})),n.push(we(window,"resize",i,{passive:!0}))}return()=>n.forEach(r=>r())}function we(e,t,n,r){return e.addEventListener(t,n,r),()=>e.removeEventListener(t,n,r)}const po=e=>t=>{e.draggable.current?De(e):e.drawable.current?on(e):t.shiftKey||Rt(t)?e.drawable.enabled&&Tr(e,t):e.viewOnly||(e.dropmode.active?ao(e,t):Hr(e,t))},At=(e,t,n)=>r=>{e.drawable.current?e.drawable.enabled&&n(e,r):e.viewOnly||t(e,r)};function ho(e){const t=z(e),n=Se(e.dom.bounds()),r=e.dom.elements.board,o=e.pieces,i=e.animation.current,l=i?i.plan.anims:new Map,s=i?i.plan.fadings:new Map,d=e.draggable.current,c=mo(e),u=new Set,a=new Set,f=new Map,h=new Map;let _,v,p,m,$,S,O,y,V,T;for(v=r.firstChild;v;){if(_=v.cgKey,fn(v))if(p=o.get(_),$=l.get(_),S=s.get(_),m=v.cgPiece,v.cgDragging&&(!d||d.orig!==_)&&(v.classList.remove("dragging"),Q(v,n(M(_),t)),v.cgDragging=!1),!S&&v.cgFading&&(v.cgFading=!1,v.classList.remove("fading")),p){if($&&v.cgAnimating&&m===ye(p)){const k=M(_);k[0]+=$[2],k[1]+=$[3],v.classList.add("anim"),Q(v,n(k,t))}else v.cgAnimating&&(v.cgAnimating=!1,v.classList.remove("anim"),Q(v,n(M(_),t)),e.addPieceZIndex&&(v.style.zIndex=Fe(M(_),t)));m===ye(p)&&(!S||!v.cgFading)?u.add(_):S&&m===ye(S)?(v.classList.add("fading"),v.cgFading=!0):Ge(f,m,v)}else Ge(f,m,v);else if(pn(v)){const k=v.className;c.get(_)===k?a.add(_):Ge(h,k,v)}v=v.nextSibling}for(const[k,R]of c)if(!a.has(k)){V=h.get(R),T=V&&V.pop();const N=n(M(k),t);if(T)T.cgKey=k,Q(T,N);else{const q=te("square",R);q.cgKey=k,Q(q,N),r.insertBefore(q,r.firstChild)}}for(const[k,R]of o)if($=l.get(k),!u.has(k))if(O=f.get(ye(R)),y=O&&O.pop(),y){y.cgKey=k,y.cgFading&&(y.classList.remove("fading"),y.cgFading=!1);const N=M(k);e.addPieceZIndex&&(y.style.zIndex=Fe(N,t)),$&&(y.cgAnimating=!0,y.classList.add("anim"),N[0]+=$[2],N[1]+=$[3]),Q(y,n(N,t))}else{const N=ye(R),q=te("piece",N),B=M(k);q.cgPiece=N,q.cgKey=k,$&&(q.cgAnimating=!0,B[0]+=$[2],B[1]+=$[3]),Q(q,n(B,t)),e.addPieceZIndex&&(q.style.zIndex=Fe(B,t)),r.appendChild(q)}for(const k of f.values())Tt(e,k);for(const k of h.values())Tt(e,k)}function go(e){const t=z(e),n=Se(e.dom.bounds());let r=e.dom.elements.board.firstChild;for(;r;)(fn(r)&&!r.cgAnimating||pn(r))&&Q(r,n(M(r.cgKey),t)),r=r.nextSibling}function Dt(e){var t,n;const r=e.dom.elements.wrap.getBoundingClientRect(),o=e.dom.elements.container,i=r.height/r.width,l=Math.floor(r.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,s=l*i;o.style.width=l+"px",o.style.height=s+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("---cg-width",l+"px"),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("---cg-height",s+"px")}const fn=e=>e.tagName==="PIECE",pn=e=>e.tagName==="SQUARE";function Tt(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function Fe(e,t){const r=e[1];return`${t?10-r:3+r}`}const ye=e=>`${e.color} ${e.role}`;function mo(e){var t,n,r;const o=new Map;if(e.lastMove&&e.highlight.lastMove)for(const s of e.lastMove)J(o,s,"last-move");if(e.check&&e.highlight.check&&J(o,e.check,"check"),e.selected&&(J(o,e.selected,"selected"),e.movable.showDests)){const s=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(s)for(const c of s)J(o,c,"move-dest"+(e.pieces.has(c)?" oc":""));const d=(r=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(e.selected))!==null&&r!==void 0?r:e.premovable.dests;if(d)for(const c of d)J(o,c,"premove-dest"+(e.pieces.has(c)?" oc":""))}const i=e.premovable.current;if(i)for(const s of i)J(o,s,"current-premove");else e.predroppable.current&&J(o,e.predroppable.current.key,"current-premove");const l=e.exploding;if(l)for(const s of l.keys)J(o,s,"exploding"+l.stage);return e.highlight.custom&&e.highlight.custom.forEach((s,d)=>{J(o,d,s)}),o}function J(e,t,n){const r=e.get(t);r?e.set(t,`${r} ${n}`):e.set(t,n)}function Ge(e,t,n){const r=e.get(t);r?r.push(n):e.set(t,[n])}function vo(e,t,n){const r=new Map,o=[];for(const s of e)r.set(s.hash,!1);let i=t.firstElementChild,l;for(;i;)l=i.getAttribute("cgHash"),r.has(l)?r.set(l,!0):o.push(i),i=i.nextElementSibling;for(const s of o)t.removeChild(s);for(const s of e)r.get(s.hash)||t.appendChild(n(s))}function _o(e,t){const r=e.drawable.autoShapes.filter(o=>o.piece).map(o=>({shape:o,hash:yo(o),current:!1}));vo(r,t,o=>wo(e,o,e.dom.bounds()))}function bo(e){var t;const n=z(e),r=Se(e.dom.bounds());let o=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;o;)Ht(o,r(M(o.cgKey),n),o.cgScale),o=o.nextSibling}function wo(e,{shape:t,hash:n},r){var o,i,l;const s=t.orig,d=(o=t.piece)===null||o===void 0?void 0:o.role,c=(i=t.piece)===null||i===void 0?void 0:i.color,u=(l=t.piece)===null||l===void 0?void 0:l.scale,a=te("piece",`${d} ${c}`);return a.setAttribute("cgHash",n),a.cgKey=s,a.cgScale=u,Ht(a,Se(r)(M(s),z(e)),u),a}const yo=e=>{var t,n,r;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(n=e.piece)===null||n===void 0?void 0:n.color,(r=e.piece)===null||r===void 0?void 0:r.scale].join(",")};function ko(e,t){const n=Fr();tn(n,t||{});function r(){const o="dom"in n?n.dom.unbind:void 0,i=co(e,n),l=sr(()=>i.board.getBoundingClientRect()),s=u=>{ho(c),i.autoPieces&&_o(c,i.autoPieces),!u&&i.svg&&Vr(c,i.svg,i.customSvg)},d=()=>{Dt(c),go(c),i.autoPieces&&bo(c)},c=n;return c.dom={elements:i,bounds:l,redraw:Co(s),redrawNow:s,unbind:o},c.drawable.prevSvgHash="",Dt(c),s(!1),uo(c,d),o||(c.dom.unbind=fo(c,d)),c.events.insert&&c.events.insert(i),c}return Ir(r(),r)}function Co(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}function So(e){let t=0;return n=>{t+=n.deltaY*(n.deltaMode?40:1),Math.abs(t)>=4?(e(n,!0),t=0):e(n,!1)}}var $o=A('<div class="is2d chessboard"> ');function Po(e){let t,n,r=C(()=>{try{return Nt(e.fen)}catch{return Ln.default()}}),o=C(()=>rr(r())),i=C(()=>r().isCheck());return On(()=>{let l=e.color,s=r().isCheck(),d={fen:e.fen,check:s,premovable:{enabled:!1},movable:{color:l,free:!1,dests:o(),events:{after:e.play_orig_key}}};n=ko(t,d)}),ee(()=>{let l;if(e.last_move){let[s]=e.last_move;l=[s.slice(0,2),s.slice(2,4)]}n.set({lastMove:l,fen:e.fen,turnColor:e.color,orientation:e.orientation??"white",check:i(),movable:{color:e.movable?e.color:void 0,dests:o()}})}),ee(()=>{n.setAutoShapes(e.shapes??[])}),(()=>{var l=$o();return Lt(s=>t=s,l),l})()}const Mo=e=>({handleEvent:xo(e),passive:!1}),xo=e=>So(t=>{const n=t.target;n.tagName!=="PIECE"&&n.tagName!=="SQUARE"&&n.tagName!=="CG-BOARD"||(t.preventDefault(),e(Math.sign(t.deltaY)))});async function qo(e){const t=await Ao(e);function n(o){return t.transaction(e.store,o).objectStore(e.store)}function r(o){return new Promise((i,l)=>{const s=o();s.onsuccess=d=>i(d.target.result),s.onerror=d=>l(d.target.result)})}return{list:()=>r(()=>n("readonly").getAllKeys()),get:o=>r(()=>n("readonly").get(o)),getMany:o=>r(()=>n("readonly").getAll(o)),put:(o,i)=>r(()=>n("readwrite").put(i,o)),count:o=>r(()=>n("readonly").count(o)),remove:o=>r(()=>n("readwrite").delete(o)),clear:()=>r(()=>n("readwrite").clear()),cursor:(o,i)=>r(()=>n("readonly").openCursor(o,i)).then(l=>l??void 0),txn:o=>t.transaction(e.store,o)}}async function Ao(e){const t=e?.db||`${e.store}--db`;return new Promise((n,r)=>{const o=window.indexedDB.open(t,e?.version??1);o.onsuccess=i=>n(i.target.result),o.onerror=i=>r(i.target.error??"IndexedDB Unavailable"),o.onupgradeneeded=i=>{const l=i.target.result,s=i.target.transaction,d=l.objectStoreNames.contains(e.store)?s.objectStore(e.store):l.createObjectStore(e.store);e.upgrade?.(i,d)}})}async function Do(e){let t;await To({on_received:i,on_status(p){p&&(p.download&&e.on_downloaded_nb(p.download),p.error&&e.on_engine_failed(p.error))},on_connected(p){t=p}}),n("uci");function n(p){t?.(p)}function r(p){d=p,_()}function o(){return!!s&&!s.stop_requested&&!s.swap_requested}function i(p){const m=p.trim().split(/\s+/g);if(m[0]==="uciok")f("UCI_Chess960","true"),n("ucinewgame"),n("isready");else if(m[0]==="readyok")u();else if(!(m[0]==="id"&&m[1]==="name"))if(m[0]==="bestmove"){s&&c&&s.emit(c),s=void 0,u();return}else if(s&&!s.swap_requested&&!s.stop_requested&&m[0]==="info"){let $=0,S,O=1,y,V,T=!1,k,R=[];for(let x=1;x<m.length;x++)switch(m[x]){case"depth":$=parseInt(m[++x]);break;case"nodes":S=parseInt(m[++x]);break;case"multipv":O=parseInt(m[++x]);break;case"time":y=parseInt(m[++x]);break;case"score":T=m[++x]==="mate",k=parseInt(m[++x]),(m[x+1]==="lowerbound"||m[x+1]==="upperbound")&&(V=m[++x]);break;case"pv":R=m.slice(++x),x=m.length;break}if(T&&!k||(l<O&&(l=O),!xe(S)||!xe(y)||!xe(T)||!xe(k)))return;const q=s.ply%2===1?-k:k;if(V&&O===1)return;const B={moves:R,cp:T?void 0:q,mate:T?q:void 0,depth:$};O===1?c={fen:s.current_fen,depth:$,nodes:S,millis:y,cp:T?void 0:q,mate:T?q:void 0,pvs:[B]}:c&&(c.pvs.push(B),c.depth=Math.min(c.depth,$)),O===l&&c&&(s.on_pvs(c),$>=40&&h())}else p&&!["Stockfish","id","option","info"].includes(m[0])&&console.warn(`SF: ${p}`)}let l=0,s,d,c;function u(){if(!s&&(s=d,d=void 0,s)){c=void 0,l=1,f("Threads",s.threads),f("Hash",s.hash_size||16),f("MultiPV",Math.max(1,s.multi_pv)),v&&v!==s.game_id&&n("ucinewgame"),v=s.game_id,n(["position fen",s.initial_fen,"moves",s.moves].join(" "));const[p,m]=Object.entries(s.search)[0];n(`go ${p} ${m}`)}}let a=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]);function f(p,m){m=m.toString(),a.get(p)!==m&&(n(`setoption name ${p} value ${m}`),a.set(p,m))}function h(){s&&!s.stop_requested&&(s.stop_requested=!0,n("stop"))}function _(){s&&!s.swap_requested&&(s.swap_requested=!0,n("stop")),n("isready")}let v;return{start(p){r(p)},stop(){r()},destroy(){n("quit")},get state(){return o()?"computing":"idle"}}}async function To(e){const t=a=>{e.on_status(a)},n=a=>{e.on_received(a)},r=a=>{e.on_connected(a)};let o=await Bn(()=>import("./sf171-79-CuIQKt_o.js"),[]),i=await new Promise((a,f)=>{o.default({wasmMemory:Eo(2560),onError:h=>f(new Error(h)),locateFile:h=>`stockfish/${h}`}).then(a).catch(f)}),l=await qo({store:".banditchess.nnue"}).catch(()=>{}),s=[];for(let a=0;;a++){let f=i.getRecommendedNnue(a);if(!f||s.includes(f))break;s.push(f)}(await c(s)).forEach((a,f)=>i.setNnueBuffer(a,f)),i.onError=u(),i.listen=a=>n(a),r(a=>i.uci(a));async function c(a){return Promise.all(a.map(async f=>{let h=await l?.get(f).catch(()=>{});if(h&&h.byteLength>128*1024)return h;const _=new XMLHttpRequest;_.open("get",`stockfish/nnue/${f}`,!0),_.responseType="arraybuffer",_.onprogress=p=>t({download:{bytes:p.loaded,total:p.total}});const v=await new Promise((p,m)=>{_.onerror=()=>m(new Error(`fetch '${f}' failed: ${_.status}`)),_.onload=()=>{_.status/100===2?p(new Uint8Array(_.response)):m(new Error(`fetch '${f}' failed: ${_.status}`))},_.send()});return t(),l?.put(f,v).catch(()=>console.warn("IDB store failed")),v}))}function u(){return a=>{if(a.startsWith("BAD_NNUE")&&l){const f=Math.max(0,Number(a.slice(9))),h=i.getRecommendedNnue(f);setTimeout(()=>{console.warn(`Corrupt NNUE file, removing ${h} from IDB`),l.remove(h)},2e3)}else t({error:a})}}}const Eo=(e,t=32767)=>{let n=4;for(;;)try{return new WebAssembly.Memory({shared:!0,initial:e,maximum:t})}catch(r){if(t<=e||!(r instanceof RangeError))throw r;t=Math.max(e,Math.ceil(t-t/n)),n=n===4?3:4}};function No(e){let t,n;return function(...r){const o=this,i=()=>{n=void 0,t=e.apply(o,r).finally(()=>{t=void 0,n&&n()})};t?n=i:i()}}function Lo(e,t){return No(function(...n){return t.apply(this,n),new Promise(r=>setTimeout(r,e))})}const Oo=(()=>{let e=0;return()=>`${e++}`})();function Bo(){let[e,t]=X(void 0),[n,r]=X(void 0),o=Wn(()=>Do({on_downloaded_nb(i){t(i)},on_engine_failed(i){r(i)}}));return{get downloaded_nb(){return e()},get engine_failed(){return n()},get protocol(){return o()}}}function Ho(e,t){let n,r=10,o=7,i=0,l=Math.max(1,navigator.hardwareConcurrency-2),s=256,d=Oo();return e.start({threads:l,hash_size:s,game_id:d,stop_requested:!1,swap_requested:!1,path:[],search:{depth:r},multi_pv:o,ply:i,threatMode:!1,initial_fen:t,current_fen:t,moves:[],emit:function(c){n(c.pvs.map(u=>({uci:u.moves[0],cp:u.cp,mate:u.mate})))},on_pvs:Lo(200,function(c){})}),new Promise(c=>{n=c})}function Ro(e){let t=Bo(),n={},[r,o]=Ot({get downloaded_nb(){return t.downloaded_nb},get engine_failed(){return t.engine_failed},pvs:n}),i=!1,l=[];function s(){if(!t.protocol||i)return;let u=l.shift();u&&(i=!0,Ho(t.protocol,u).then(a=>{o("pvs",u,a),i=!1,s()}))}ee(de(()=>t.protocol,s));let c=[r,{request_multipv(u){l.push(u),s()}}];return w(hn.Provider,{value:c,get children(){return e.children}})}const hn=Hn();function Wo(){return Rn(hn)}const Ko=(e=0)=>()=>{var t=Math.sin(e++)*1e4;return t-Math.floor(t)},gn=Ko();function mn(e=gn){return e()<.5?-1:1}function zo(e,t,n=gn){return Math.floor(n()*(t-e)+e)}function ke(e){return e[zo(0,e.length)]}var jo=A("<section class=sliced-text> <!> "),Io=A("<div class=aurora-text><div class=title><div class=aurora><div class=aurora__item></div><div class=aurora__item></div><div class=aurora__item></div><div class=aurora__item>"),Fo=A("<div class=marquee> <span></span> ");function Go(e){return(()=>{var t=jo(),n=t.firstChild,r=n.nextSibling;return r.nextSibling,b(t,()=>e.text,r),Le(()=>Kn(t,"data-heading",e.text)),t})()}function Vo(e){return(()=>{var t=Io(),n=t.firstChild,r=n.firstChild;return b(n,()=>e.text,r),t})()}function Qe(e){return(()=>{var t=Fo(),n=t.firstChild,r=n.nextSibling;return b(r,()=>e.text),t})()}var Uo=A("<div class=modal-overlay><div class=modal><div class=game-over-popup><h2>New High Score</h2><div class=leaderboards>"),Yo=A('<main class=vs><div class=background><div class=p1></div><div class=p2></div></div><div class=content><div class=info><h3>Bandit vs Stockfish</h3><span>Match #</span></div><div class=board-wrap><div class=board></div></div><div class=replay-wrap><div class=top-padding></div><div class=user-top><span class="user ai">Stockfish</span><span class=time>0:00</span></div><div class=replay><div class=scores></div></div><div class=controls></div><div class=user-bottom><span class=user>You</span><span class=time>0:00</span></div><div class=bottom-padding></div></div><div class=history>'),Zo=A("<div class=downloading><span>Downloading Stockfish..</span><div class=bar>"),Xo=A('<input type=text placeholder="Enter Your Handle"maxlength=8 minlength=3>'),Qo=A("<div class=high-score-review><div class=buttons>"),Jo=A("<small>Don't Show Again"),ei=A("<div class=feedback><p>Did you like Bandit Chess?</p><div class=buttons>"),ti=A("<div class=note><div class=marquee> <span>Personal Best Achieved.</span> "),ni=A("<div class=note2>"),ri=A("<div class=win><span class=header></span><div class=scores><span class=score>Score: </span><span class=combo>Combo: "),oi=A("<div class=result><span class=over>Game Over</span><small>"),ii=A("<div class=lose><span class=header>"),si=A("<div class=score-delta><span class=score></span><div class=combo-streak><span class=streak>x</span><span class=combo>"),li=A("<div class=list-wrap><div class=list><div class=padding>"),ci=A("<div class=padding>"),ai=A("<span class=step> <!> <span class=delta> </span> ");const di=".banditchess.vs-stockfish-save.v0";function Ci(){return w(Ro,{get children(){return w(ui,{})}})}function ui(){let[e,{request_multipv:t}]=Wo();const n=()=>e.downloaded_nb,r=()=>e.engine_failed,o=C(()=>{let g=n();if(g){let P=Math.round(g.bytes/g.total*100);return console.log(g.bytes,g.total,P),P===100?void 0:P}});ee(()=>{console.log(r())});let[i,{initialize_replay:l,add_uci_and_goto_it:s,set_cursor_path:d,goto_next_path_if_can:c,goto_prev_path_if_can:u,submit_vote:a}]=bt();const[f,h]=zn(Ot({color:mn()?"white":"black",nth:1,sans:[],cursor_path:"",game_result:void 0,fen_pvs:{},show_vote:!0}),{name:di}),_=()=>f.nth;function v(g){h("sans",f.sans.length,g.san),h("cursor_path",g.path)}const p=()=>f.color,m=()=>yt(p()),$=C(()=>i.replay.list),S=C(()=>i.replay.fen),O=C(()=>i.replay.last_move),y=C(()=>f.fen_pvs[S()]!==void 0),V=()=>f.game_result===void 0&&y();l(f.sans,f.cursor_path);const T=C(()=>i.replay.list.map(g=>{let P=f.fen_pvs[g.before_fen];if(P)return mi(P,g.uci)})),k=C(()=>i.replay.list.length<10),R=g=>{let P=C(()=>{let E=[],L=T();for(let j=g==="white"?10:11;j<L.length;j+=2)E.push(L[j]);return E}),U=C(()=>P().reduce((E,L)=>E+(L??0),0)),Y=C(()=>{let E=[],L=P(),j=1;for(let W=0;W<L.length;W++){let Z=L[W];if(Z===void 0){E.push(E[E.length-1]??2);continue}Z>0?(E.push(j),j++):(j=1,E.push(j))}return E}),ie=C(()=>Y()[Y().length-1]??0),ve=C(()=>{let E=P(),L=Y(),j=[];for(let W=0;W<E.length;W++){let Z=E[W];Z&&j.push(Z*vn(L[W]))}return j.reduce((W,Z)=>W+Z,0)}),_e=C(de(ie,(E,L)=>L===void 0?0:E-L)),Ke=()=>0,ze=()=>0;return{get classic(){return U()},get streak(){return ie()},get combo(){return ve()},get streak_delta(){return _e()},get classic_delta(){return Ke()},get combo_delta(){return ze()}}},N=g=>{if(!g)return;let[P,U]=g;if(!f.fen_pvs[P]&&(h("fen_pvs",P,U),P===S()&&nr(P)===m())){let Y=gi(U);v(s(Y.uci)),B()}},q=(g,P)=>{let U=g+P;{let Y=Nt(S()),ie=Y.turn;Y.board.get(Yn(g)).role==="pawn"&&(P[1]==="8"&&ie==="white"||P[1]==="1"&&ie==="black")&&(U+="q")}v(s(U)),B()},B=()=>{if(Gn(S())){let g=["game-ended",Vn(S())];h("game_result",g),We(Re()!==void 0)}else Un(S())?(h("game_result",["40-reached",void 0]),We(Re()!==void 0)):t(S())},x=()=>{er(()=>{h("color",yt(f.color)),h("game_result",void 0),h("nth",g=>g+1),h("sans",kt([])),h("cursor_path",""),h("fen_pvs",kt({})),l([],""),B()})},_n=()=>{x()};let ct=jn();const bn=()=>{x(),ct("/")},wn=()=>{x(),ct("/top")},yn=g=>{g>0?c():u()};In(de(()=>{let g=e.pvs[S()];if(g)return[S(),g]},N));let at=C(()=>R("white")),dt=C(()=>R("black")),$e=C(()=>p()==="white"?at():dt()),[{leaderboard:ge},{add_top_score:kn,add_top_combo:Cn}]=bt();const[Oe,Sn]=X(""),[me,ut]=X(!1),Be=C(()=>[Oe(),$e().classic,Date.now()]),He=C(()=>[Oe(),$e().combo,Date.now()]),ft=C(()=>{if(!f.game_result||f.game_result[1]!==p())return;let g=wt(ge.top_scores,Be());if(g!==-1)return g}),pt=C(()=>{if(!f.game_result||f.game_result[1]!==p())return;let g=wt(ge.top_combos,He());if(g!==-1)return g});function ht(g,P,U){return g=g.slice(0),g.splice(P,0,U),g.pop(),g}const gt=C(()=>{let g=ft();if(g!==void 0)return me()?ge.top_scores:ht(ge.top_scores,g,Be())}),mt=C(()=>{let g=pt();if(g!==void 0)return me()?ge.top_combos:ht(ge.top_combos,g,He())}),Re=C(()=>gt()||mt()),[$n,We]=X(!1),Pn=g=>{Sn(g)},Mn=()=>{kn(Be()),Cn(He()),ut(!0)},[xn,qn]=X(f.show_vote),An=()=>{We(!1),ut(!1)},Dn=()=>{h("show_vote",!1)},Tn=g=>{a(Oe(),g),qn(!1)};return B(),(()=>{var g=Yo(),P=g.firstChild,U=P.nextSibling,Y=U.firstChild,ie=Y.firstChild,ve=ie.nextSibling;ve.firstChild;var _e=Y.nextSibling,Ke=_e.firstChild,ze=_e.nextSibling,E=ze.firstChild,L=E.nextSibling,j=L.firstChild;j.nextSibling;var W=L.nextSibling,Z=W.firstChild,vt=W.nextSibling;return b(ve,_,null),Fn(_e,"wheel",Mo(yn)),b(Ke,w(Po,{get orientation(){return p()},get movable(){return V()},get color(){return p()},get fen(){return S()},get last_move(){return O()},play_orig_key:q})),b(L,w(I,{get when(){return o()},children:se=>(()=>{var Pe=Zo(),be=Pe.firstChild,Me=be.nextSibling;return Le(le=>(le=`${se()}%`)!=null?Me.style.setProperty("width",le):Me.style.removeProperty("width")),Pe})()}),null),b(W,w(vi,{onSetCursorPath:d,get cursor_path(){return i.replay.cursor_path},get steps(){return $()},get deltas(){return T()},get children(){return w(I,{get when(){return f.game_result},children:se=>w(hi,{get result(){return se()[0]},get top(){return Re()!==void 0},get win(){return se()[1]===p()},get score(){return $e().classic},get combo(){return $e().combo}})})}}),Z),b(Z,w(Et,{get small(){return p()==="black"},flip:!0,get skip(){return k()},get scores(){return at()}}),null),b(Z,w(Et,{get small(){return p()==="white"},flip:!1,get skip(){return k()},get scores(){return dt()}}),null),b(vt,w(ue,{meet:!0,onClick:_n,children:"Restart"}),null),b(vt,w(ue,{meet:!0,onClick:bn,children:"Go Home"}),null),b(g,w(I,{get when(){return $n()},get children(){var se=Uo(),Pe=se.firstChild,be=Pe.firstChild,Me=be.firstChild,le=Me.nextSibling;return b(be,w(Qe,{text:"Personal Best Achieved"}),le),b(be,w(I,{get when(){return me()},get fallback(){return(()=>{var ce=Xo();return ce.addEventListener("change",Mn),ce.$$input=En=>Pn(En.target.value),ce})()},get children(){return w(I,{get when(){return xn()},get fallback(){return w(fi,{onBackToGame:An,onGoHighscores:wn})},get children(){return w(pi,{onSkip:Dn,onClose:Tn})}})}}),le),b(le,w(I,{get when(){return gt()},children:ce=>w(Ct,{title:"Top Scores",get scores(){return ce()},get highlight(){return Ve(()=>!!me())()?void 0:ft()}})}),null),b(le,w(I,{get when(){return mt()},children:ce=>w(Ct,{title:"Top Combo",get scores(){return ce()},get highlight(){return Ve(()=>!!me())()?void 0:pt()}})}),null),se}}),null),g})()}function fi(e){return(()=>{var t=Qo(),n=t.firstChild;return b(n,w(ue,{get onClick(){return e.onGoHighscores},meet:!0,children:"See High Scores"}),null),b(n,w(ue,{get onClick(){return e.onBackToGame},draw:!0,children:"Back to Game"}),null),t})()}function pi(e){const t=n=>{n==="skip"&&e.onSkip(),e.onClose(n)};return(()=>{var n=ei(),r=n.firstChild,o=r.nextSibling;return b(o,w(ue,{onClick:()=>t("yes"),draw:!0,children:"Yes"}),null),b(o,w(ue,{onClick:()=>t("no"),draw:!0,meet:!0,children:"No"}),null),b(o,w(ue,{onClick:()=>t("skip"),gray:!0,get children(){return Jo()}}),null),n})()}function hi(e){return(()=>{var t=oi(),n=t.firstChild,r=n.nextSibling;return b(r,w(I,{get when(){return e.result==="40-reached"},children:"Move 40 reached."}),null),b(r,w(I,{get when(){return e.result==="game-ended"},children:"There has been a checkmate."}),null),b(t,w(I,{get when(){return e.win},get fallback(){return(()=>{var o=ii(),i=o.firstChild;return b(i,w(Go,{text:"You lost"})),o})()},get children(){var o=ri(),i=o.firstChild,l=i.nextSibling,s=l.firstChild;s.firstChild;var d=s.nextSibling;return d.firstChild,b(i,w(Vo,{text:"You Win!"})),b(s,()=>e.score,null),b(d,()=>e.combo,null),b(o,w(I,{get when(){return e.top},get children(){var c=ti();return c.firstChild,b(c,w(Qe,{text:"Personal Best Achieved."}),null),c}}),null),b(o,w(I,{when:!1,get children(){var c=ni();return b(c,w(Qe,{text:"Top Leaderboard Achieved."})),c}}),null),o}}),null),t})()}const vn=e=>e>2?4:e>1?3:2;function Et(e){const t=e.scores,n=C(de(()=>e.scores.classic,p=>(setTimeout(()=>s(!1),200),p))),r=C(de(()=>e.scores.streak,(p,m)=>(setTimeout(()=>c(!1),200),[p,m??2]))),o=C(de(()=>e.scores.combo,p=>(setTimeout(()=>a(!1),200),p))),i=C(de(()=>e.scores.streak,(p,m)=>(setTimeout(()=>h(!1),200),[p,m??2]))),[l,s]=X(!1),[d,c]=X(!1),[u,a]=X(!1),[f,h]=X(!1);ee(()=>s(n()!==void 0)),ee(()=>c(_(r()))),ee(()=>a(o()!==void 0)),ee(()=>h(v(i())));const _=p=>p[0]>p[1],v=p=>p[0]<p[1];return(()=>{var p=si(),m=p.firstChild,$=m.nextSibling,S=$.firstChild;S.firstChild;var O=S.nextSibling;return b(m,()=>t.classic),b(S,()=>vn(t.streak),null),b(O,()=>t.combo),Le(y=>{var V=!!e.flip,T=!!e.small,k=!!e.skip,R=!!l(),N=!!e.skip,q=!!d(),B=!!f(),x=!!u();return V!==y.e&&p.classList.toggle("flip",y.e=V),T!==y.t&&p.classList.toggle("small",y.t=T),k!==y.a&&m.classList.toggle("skip",y.a=k),R!==y.o&&m.classList.toggle("bump",y.o=R),N!==y.i&&$.classList.toggle("skip",y.i=N),q!==y.n&&S.classList.toggle("bump",y.n=q),B!==y.s&&S.classList.toggle("shoot",y.s=B),x!==y.h&&O.classList.toggle("bump",y.h=x),y},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),p})()}function gi(e){let t=e[0].cp;if(!t)return e[0];let n=e.filter(a=>a.cp&&Math.abs(a.cp)-Math.abs(t)<10),r=e.filter(a=>a.cp&&Math.abs(a.cp)-Math.abs(t)<20),o=e.filter(a=>a.cp&&Math.abs(a.cp)-Math.abs(t)<60),i=e.filter(a=>a.cp&&Math.abs(a.cp)-Math.abs(t)>=60),l=ke(n),s=ke(r),d=ke(o),c=ke(i),u=[];return l&&(u.push(l),u.push(l),u.push(l),u.push(l)),s&&(u.push(s),u.push(s),u.push(s)),d&&(u.push(d),u.push(d)),c&&(u.push(c),mn()&&(u.push(c),u.push(c),u.push(c))),ke(u)}function mi(e,t){let n=e.findIndex(r=>r.uci===t);return n===-1?0:e.length-n-1}function vi(e){let t;ee(()=>{let r=e.cursor_path,o=t.parentElement;if(!o)return;const i=t.querySelector(".on-path-end");if(!i){o.scrollTop=r.length>0?99999:0;return}if(n()!==void 0){o.scrollTop=99999;return}let l=i.offsetTop-o.offsetHeight/2+i.offsetHeight;o.scrollTo({behavior:"smooth",top:l})});let n=Zn(()=>e.children);return[(()=>{var r=li(),o=r.firstChild,i=o.firstChild;return Lt(l=>{t=l},o),b(o,w(Qn,{get each(){return e.steps},children:(l,s)=>w(_i,Xn(e,{get is_opening(){return s()<10},get delta(){return e.deltas[s()]},step:l}))}),i),b(o,n,null),r})(),ci()]}function _i(e){const t=e.step,n=(l,s)=>s===void 0?"...":l?s:s===0?"0":`+${s}`,r=(l,s)=>s===void 0?"":o()?l?"opening":s>=5?"five":s>2?"four":s>0?"one":"zero":"",[o,i]=X(!1);return setTimeout(()=>i(!0),100),(()=>{var l=ai(),s=l.firstChild,d=s.nextSibling,c=d.nextSibling,u=c.nextSibling,a=u.firstChild;return l.$$click=()=>e.onSetCursorPath(t.path),b(l,(()=>{var f=Ve(()=>t.ply%2===1);return()=>f()?bi(t.ply):""})(),s),b(l,()=>t.san,d),b(u,()=>n(e.is_opening,e.delta),a),Le(f=>{var h=t.path===e.cursor_path,_={opening:e.is_opening,[r(e.is_opening,e.delta)]:!0};return h!==f.e&&l.classList.toggle("on-path-end",f.e=h),f.t=Jn(u,_,f.t),f},{e:void 0,t:void 0}),l})()}const bi=e=>`${Math.ceil(e/2)}.`+(e%2===0?"..":"");tr(["input","click"]);export{di as PERSIST_NAME_PLAY_SHOW_STATE,Ci as default,bi as ply_to_index};
